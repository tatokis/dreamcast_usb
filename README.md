# Dreamcast controller to USB adapter firmware

AVR micro-controller firmware for a Dreamcast controller to USB adapter. [This is a fork of the original project](https://github.com/raphnet/dreamcast_usb).

## Changes from the original

1. Since this is a fork, **the USB Ven/Dev IDs have been zeroed out**. Please insert yours in `usbdev.h`.
2. HID Descriptor for the gamepad has been reworked to be more compatible with modern software. (Not XInput compatible.)
    * The triggers have been switched to Rx and Lx axes since only one slider seemed to be recognised previously.
    * Extra buttons have been added for the triggers (soft/hard pull).
    * The D-Pad has been converted to a Hat Switch. As a result, the button numbers differ.
3. Analog stick range has been limited so that both axes are at their extreme ends when pointing to a corner. See [Hardware](#hardware).
4. Makefile now builds for the ATmega328p. See [Fuses](#fuses).
5. bcdDevice is now `1.1`.

## Steam Input / SDL

To map this to an XInput compatible controller for SDL, the following line can be used:

```
0300fb419b2800000800000001010000,raphnet.net Dreamcast to USB mod,crc:41fb,platform:Linux,a:b2,b:b1,x:b6,y:b5,dpleft:h0.8,dpright:h0.2,dpup:h0.1,dpdown:h0.4,leftx:a0,lefty:a1,lefttrigger:a3,righttrigger:a2,start:b3,steam:2,
```

**NOTE**: This was generated by Steam using the origianl Ven/Dev ID pair. It will not work as-is with the default 0000:0000 or any custom one.

Alternatively, everything can be manually mapped using Steam. (Big Picture -> Settings -> Controller -> Test Device Inputs/Begin Test -> Setup Device Inputs)

If Steam allows it, one may also copy the above line to the clipboard and paste it within Steam in Setup Device Inputs. (Paste seems to do nothing on my end.)

## Supported micro-controllers

Currently supported micro-controllers:

* ATmega328p

Adding support for other micro-controllers should be easy, as long as the target has enough
IO pins, enough memory (flash and SRAM) and is supported by V-USB.

## Fuses

Since the ATmega328p is used, the fuses need to be configured as follows.
```
lfuse = 0xd7
hfuse = 0xdb
efuse = 0xfd
```

If you run the ATmega at 5V (see [Hardware](#hardware)), you can change efuse to `0xfc` for brown-out detection at 4.3V.

## Hardware

The original schematic should work out of the box. Personally, I decided to run the ATmega at 5V with the zener diodes on the USB port and an LDO + logic level converter ([SparkFun BOB-12009](https://www.sparkfun.com/sparkfun-logic-level-converter-bi-directional.html)) for the Maple bus.

To disable the limited analog stick range and revert back to the original behaviour, add a switch to PD6 (Pin 12 on the ATmega328p), pulling it down to GND. The internal pull-up resistor is enabled for that pin.

## Original project homepage

Schematic and additional information are available on the project homepage:

English: [Dreamcast controller to USB adapter](http://www.raphnet.net/electronique/dreamcast_usb/index_en.php)
French: [Adaptateur manette Dreamcast Ã  USB](http://www.raphnet.net/electronique/dreamcast_usb/index.php)

## Built with

* [avr-gcc](https://gcc.gnu.org/wiki/avr-gcc)
* [avr-libc](http://www.nongnu.org/avr-libc/)
* [gnu make](https://www.gnu.org/software/make/manual/make.html)

## License

This project is licensed under the terms of the GNU General Public License, version 2.

## Acknowledgments

* Massive thank you to raphnet for originally creating this, and many more awesome projects.
* Thank you to Objective development, author of [V-USB](https://www.obdev.at/products/vusb/index.html) for a wonderful software-only USB device implementation.
